<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.example.sample.service.impl.RestroomMapper">

    <select id="selectStallList" resultType="egovframework.example.sample.service.StallVO">
        SELECT 
            stall_id AS stallId, 
            stall_name AS stallName, 
            is_occupied AS isOccupied 
        FROM stall
    </select>

    <select id="selectLatestSensor" parameterType="String" resultType="egovframework.example.sample.service.SensorVO">
        SELECT value, measured_at as readingTime 
        FROM sensor_reading 
        WHERE sensor_type = #{sensorType} 
        ORDER BY measured_at DESC 
        LIMIT 1
    </select>

    <select id="selectStockList" resultType="egovframework.example.sample.service.StockVO">
        SELECT 
            type_key AS typeKey, 
            current_level AS currentLevel, 
            threshold 
        FROM consumable
    </select>

    <select id="selectTodayVisitor" resultType="int">
        SELECT daily_count AS todayVisitor
        FROM visitor_manager 
        WHERE manager_id = 1
    </select>
    
    <select id="selectHourlyStats" resultType="egovframework.example.sample.service.VisitorVO">
        SELECT 
            hour_id AS hourId, 
            visit_count AS visitCount, 
            yesterday_count AS yesterdayCount
        FROM hourly_stats
        WHERE hour_id BETWEEN 8 AND HOUR(NOW())
        ORDER BY hour_id
    </select>

    <select id="selectAlertSettings" resultType="egovframework.example.sample.service.AlertSettingVO">
        SELECT 
            sensor_type AS sensorType, 
            is_enabled AS isEnabled 
        FROM alert_setting
    </select>
    
    <select id="selectVisitComparison" resultType="egovframework.example.sample.service.VisitorVO">
        SELECT 
            SUM(visit_count) AS todayCount, 
            SUM(yesterday_count) AS yesterdayCount
        FROM hourly_stats
        WHERE hour_id &lt;= HOUR(NOW())
    </select>

    <resultMap id="ThresholdResultMap" type="egovframework.example.sample.service.ThresholdVO">
	    <result property="sensorType" column="sensor_type"/>
	    <result property="minValue" column="min_value"/>
	    <result property="maxValue" column="max_value"/>
	    <result property="alertInterval" column="alert_interval"/>
	</resultMap>
	
	<select id="selectAllThresholds" resultMap="ThresholdResultMap">
	    SELECT sensor_type, min_value, max_value, alert_interval 
	    FROM sensor_threshold
	</select>
	
	<select id="selectConsumableThresholds" resultType="egovframework.example.sample.service.StockVO">
        SELECT type_key AS typeKey, current_level AS currentLevel, threshold FROM consumable
    </select>

    <update id="updateSensorThreshold" parameterType="egovframework.example.sample.service.ThresholdVO">
        UPDATE sensor_threshold 
        SET 
            min_value = #{minValue}, 
            max_value = #{maxValue}, 
            alert_interval = #{alertInterval}
        WHERE sensor_type = #{sensorType}
    </update>

    <update id="updateAlertSetting" parameterType="egovframework.example.sample.service.AlertSettingVO">
        UPDATE alert_setting 
        SET is_enabled = #{isEnabled}
        WHERE sensor_type = #{sensorType}
    </update>

    <update id="updateConsumableThreshold" parameterType="egovframework.example.sample.service.StockVO">
        UPDATE consumable 
        SET threshold = #{threshold}
        WHERE type_key = #{typeKey}
    </update>
	
	
	<select id="selectSensorLogList" parameterType="map" resultType="egovframework.example.sample.service.SensorVO">
	    SELECT 
	        sensor_type AS sensorType, 
	        value, 
	        measured_at AS readingTime,
	        stall_id AS stallId,
	        status
	    FROM sensor_reading 
	    WHERE 1=1
	    
	    <if test="sensorTypeList != null and sensorTypeList.size > 0">
	        AND sensor_type IN 
	        <foreach item="type" collection="sensorTypeList" open="(" separator="," close=")">
	            #{type}
	        </foreach>
	    </if>
	    
	    <if test="startDate != null and startDate != ''">
	        AND measured_at &gt;= CONCAT(#{startDate}, ' 00:00:00')
	    </if>
	    
	    <if test="endDate != null and endDate != ''">
	        AND measured_at &lt;= CONCAT(#{endDate}, ' 23:59:59')
	    </if>
	    
	    ORDER BY measured_at DESC 
	    LIMIT 100000
	</select>
	
	<select id="selectAlertLogList" parameterType="map" resultType="egovframework.example.sample.service.AlertVO">
    SELECT 
        alert_id AS alertId,
        alert_type AS alertType,
        severity, 
        content,
        value,
        created_at AS createdAt
    FROM alert
    WHERE 1=1
    
    <if test="alertType != null and alertType != '' and alertType != 'ALL'">
        AND alert_type = #{alertType}
    </if>
    
    <if test="severity != null and severity != '' and severity != 'ALL'">
        AND severity = #{severity}
    </if>
    
    <if test="startDate != null and startDate != ''">
        AND created_at &gt;= CONCAT(#{startDate}, ' 00:00:00')
    </if>
    
    <if test="endDate != null and endDate != ''">
        AND created_at &lt;= CONCAT(#{endDate}, ' 23:59:59')
    </if>
    
    ORDER BY created_at DESC 
    LIMIT 10000
</select>
    
    <select id="selectAdminLogin" parameterType="java.util.Map" resultType="java.lang.String">
	    SELECT user_name
	    FROM admin_user
	    WHERE user_id = #{id} 
	      AND user_pw = #{pw}
	</select>
</mapper>